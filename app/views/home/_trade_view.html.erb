<% coins = filter_trade( @coins, @trade_coin ) %>
<% trade_coin = coins.first %>

<table class = 'table'>

  <caption id='caption'>
    <h4>
      <%= ( trade_coin['name'] + ' trade  ' ).titleize %>
      <img style="width: 40px;" src=<%= trade_coin['image']%>>
    </h4>
  </caption>
  
  <thead>
    <tr>
      <th>Coin</th>
      <th>Data</th>
      <th>Trade</th>
    </tr>
  </thead>
  
  <% coins.each_with_index do |coin, index| %>
    <% user_coin = user(coin) %>
    <% long_gain = coin['long_gain'] %>
    <% short_gain = coin['short_gain'] %>
    
    <% id_target = 'prog-' + index.to_s %>
    <% status = coin['vs_24h'] %>
    <% data = status.to_s + '%' %>
    <% index = index.to_s %>
    
    <tbody>
      <tr id="<%= coin['id'] %>">
        <td style="font-size: smaller;">
          <div style="font-size: smaller;">
            <% if long_gain == 'N/A' %>
              <%= long_gain %>
            <% else %>
              <% color_a = "color:" + ( long_gain >= 0 ? "green" : "red" ) %>
            
              <em style=<%= color_a %>>
                <%= long_gain.round(2) %>
              </em>
            <% end %>
            
            <% if short_gain == 'N/A' %>
              <%= short_gain %>
            <% else %>
              <% color = "color:" + ( short_gain >= 0 ? "green;" : "red;" ) + "font-size:" + "xx-small" %>

              <em style=<%= color %>>
                <%= short_gain.round(2) %>
              </em>
            <% end %>
          </div>
          
          <hr style="margin-top: 0%; margin-bottom: 0%; width: 70px" >

          <em style="font-size: smaller; margin-top: 0%"><%= coin['id'] %></em>

          <hr style="margin-top: 3px; margin-bottom: 0%; width: 70px" >

          <em style="font-size: 8px;">
            <%= "\u{20B1}".encode('utf-8') + humanize_price( current_price_of( coin ) ).to_s %>
          </em>
        </td>

        <td style="padding:0%">
          <div style="margin-top:20px;">
            <div class="progress" style="width: 100px; margin-top:7px">
              <div id=<%= id_target %> class="progress-bar <%= 'bg-info' %>" role="progressbar" aria-valuenow="41" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          
            <div class="my-grid" style="width: 100px" >
              <% trend_sum = sum_price_changes(coin['trend']) %>
            
              <% coin['trend'].each_with_index do |trend, index| %>
                <% trend_color, trend_value = trend %>
                <% trend_change = percentage_between( trend_value, trend_sum ) %>
              
                <% trend = "width:" + trend_change.to_s + '%;' + "background-color:" + trend_color %>
                <% trend_class = 'col-' + (index + 1).to_s + '-10 '%>

                <% unless trend_change < 1 %>
                  <div class=<%= trend_class %> style=<%= trend %>></div>
                <% end %>
              <% end %>
            </div>
          </div>
        </td>

        <td>
          <% unless coin['id'] == @trade_coin %>
            <%= link_to coins_make_trade_path( buy: coin['id'], sell: @trade_coin ), method: 'post', data: { confirm: 'Are you sure you want to trade these coins?' } do %>
              <button  type="button" class="btn btn-outline-warning btn-sm" style="width:75px; height: 30px; font-size:xx-small; margin-top: 13px">
                <img src=<%= trade_coin['image'] %> style="width: 21px">
                =>
                <img src=<%= coin['image']%> style="width: 21px">
              </button>
            <% end %>
          <% end %>
        </td>
      </tr>
    </tbody>

    <style>
      :root {
      --data: <%= data %>;
      --index: <%= index %>;
    }
    </style>

    <script>
      var css_root = document.querySelector(':root');
      var css_data = getComputedStyle(css_root);
  
      var data = css_data.getPropertyValue('--data');
      var index = css_data.getPropertyValue('--index');

      data_arr.push(data)
      id_arr.push(Number(index))

      render_data(data_arr, id_arr);
    </script>
  <% end %>
</table>

<%= render 'refresh_timer' unless @observe %>
